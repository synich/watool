#include <stdio.h>
#include <string.h>
#ifdef _WIN32
#include <windows.h>
#define DIR_SEP "\\"
#else
#include <unistd.h>
#define DIR_SEP "/"
#endif
#include "walib.h"
#define SUPPORT_LUA
#ifdef SUPPORT_LUA
#include "lua.h"
#include "lauxlib.h"
#include "lualib.h"
int luaopen_utf8(lua_State *L);
int luaopen_enc(lua_State *L);
int luaopen_dt(lua_State *L);
#else
void get_exe_path(char* wd);
#include "dep/bignum.c"
#include "dep/miniscm.c"
#endif

#define MAXLINE 256

void usage(){
  puts("personal busybox ver231220\nascii\n"
  "dyn2str file -- convert script into C string file\n"
  "snip|comp [keyword]\n"
  "todo sth|[d line]\n"
#ifdef SUPPORT_LUA
  "lua [-y] file [argv] or -e expr or -h show extention\n"
  "el file -- convert lua to c code\n"
#else
  "lisp file\n"
#endif
  "hsc helper show cvs\n\tmf(list modified file)|ml(number modified line)|rv(repo version)\n"
  "wph(WaProjectHelper)\n\twph c c -- create c project scafold\n\twph l p -- generate lua plugin by c\n"
  "xlispindent file|stdin"
  );
  exit(0);
}


int frontcmp(const char* s, const char* target, int most){
  int tlen = strlen(target);
  for(;most<=tlen;most++){
    if (0==strncmp(s,target,most)){return 0;}
  }
  return strncmp(s,target, tlen);
}


/******** show ascii char ********/
void ascii(){
  int i = 32;
  for (; i<32+24; i++){
    printf("0x%x,%d: %c\t\t0x%x,%d: %c\t\t0x%x,%d: %c\t\t0x%x,%d: %c\n",
      i, i, i, i+24, i+24, i+24, i+48, i+48, i+48, i+72, i+72, i+72);
  }
}


/******** snip ********/
void get_exe_path(char* wd){
#ifdef _WIN32
  char *pos;
  GetModuleFileName(NULL, wd, MAXLINE);
  pos = strstr(wd, ".exe");
  *pos=0;
#else
  int ret = readlink("/proc/self/exe", wd, MAXLINE);
  wd[ret] = 0;
#endif
  strcat(wd, "_d"DIR_SEP);
}

/*wh: 0-title 1-para
  to: 0-stdout 1-_pb_out
  return: -1 fail 0 OK*/
static int get_paragraph(const char* fname, int wh, const char* kwd, int to){
  FILE *fout = stdout;
  FILE *f = fopen(fname, "r");
  if (NULL==f){
    int pend = strlen(fname);
    char chend = fname[pend-1];
    if ('p'==chend){printf("cant find '%s'\n",fname);}
    return -1;
  }
  if (1==to) {
    char fop[MAXLINE];
    get_exe_path(fop);
    strcat(fop, "_pb_out");
    fout = fopen(fop, "w");
  }
  char line[MAXLINE];
  int fl_len = strlen(kwd);
  int out_flag = 0;
  while(fgets(line, MAXLINE, f)){
    if (0==wh){
      if (0==strncmp(line, kwd, fl_len)){
        char *pos = strchr(line, '_');
        fprintf(fout, "%s", pos+1);
      }
    }else{
      if (out_flag==1){
        if (0==strncmp(line, "@@", 2)) {
          break;
        } else {
          fprintf(fout, "%s", line);
        }
      } else if (0==strncmp(line, kwd, fl_len)){
        out_flag = 1;
      }
    }
  }
  fclose(f);
  if (1==to) {fclose(fout);}
  return 0;
}

/*wh: 0-snip 1-comp*/
void snip(int argc, char** argv, int wh, int to){
  char fl_str[MAXLINE];
  char fname[MAXLINE];
  char* snip_flag[2] = {"snip", "comp"};
  int i=1, pend;
  sprintf(fl_str, "# %s_", snip_flag[wh]);
  get_exe_path(fname);
  strcat(fname, "_pb_snip");
  pend = strlen(fname);
#define SNIP_POST 9
  if (argc==0){ /*see what section in this snip*/
    get_paragraph(fname, 0, fl_str, to);
    for (;i<=SNIP_POST;i++){
      fname[pend]='0'+i;fname[pend+1]=0;
      if (-1==get_paragraph(fname, 0, fl_str, to)){break;}
    }
  } else {
    strcat(fl_str, argv[0]);
    if (argc>=2){
      char mor_str[MAXLINE];
      sprintf(mor_str, "#%s %s", fl_str, argv[1]);
      strcpy(fl_str, mor_str);
    }
    get_paragraph(fname, 1, fl_str, to);
    for (;i<=SNIP_POST;i++){
      fname[pend]='0'+i;fname[pend+1]=0;
      if (-1==get_paragraph(fname, 1, fl_str, to)){break;}
    }
  }
}


/******** help_show_csv ********/
void help_show_csv(int argc, char** argv){
#define MODFILE "mf"
#define MODLINE "ml"
#define REPOVER "rv"
  if (1==argc){
    usage();
  } else {
    if (0==strcmp(argv[1], MODFILE)) {
      system("cvs st | grep Modified");
    } else if (0==strcmp(argv[1], MODLINE)) {
      system("cvs diff | grep \"^>\" | wc -l");
     } else if (0==strcmp(argv[1], REPOVER)) {
      system("cvs st | grep Repository");
   } else {
      puts("Unknown command, see help without argument.");
    }
  }
}


/******** dyn2str ********/
static void convFile(unsigned char* str, int slen, FILE* fout){
  int i=0;
  char buf[8] = {0};
  for (; i<slen; i++) {
    if (0 == i%10){
      fwrite("\n", 1, 1, fout);
    }
    snprintf(buf, sizeof(buf), "%u,", str[i]);
    fwrite(buf, strlen(buf), 1, fout);
  }
}

/* Convert script language source to C style string.
   So you can embed source into binary file, not confuse just combine.*/
void dyn2str(int argc, char *argv[])
{
  FILE *fin = NULL, *fout = NULL;
  char buf[128] = {0};
  char *pos = NULL;
  unsigned char *chin = NULL;
  int insize = 0;

  if (argc <= 1) {
    usage();
  }

  /* if input is script.ext, output file name is script_ext.c */
  snprintf(buf, sizeof(buf), "%s.c", argv[1]);
  pos = strchr(buf, '.');
  *pos = '_'; /*At least has one .c, must available*/

  fin = fopen(argv[1], "r");
  fout = fopen(buf, "w");
  fseek(fin, 0, SEEK_END);
  insize = ftell(fin);
  rewind(fin);

  /* write C string declare */
  snprintf(buf, sizeof(buf), "static const unsigned char s_%s_str[]={", argv[1]);
  chin = (unsigned char*)strchr(buf, '.');
  if (chin) {*chin = '_';} /*Origin file no extname, dont overwrite here*/
  fwrite(buf, strlen(buf), 1, fout);

  /* write script content */
  chin = (unsigned char*)calloc(1, insize + 2);
  insize = fread(chin, sizeof(char), insize, fin);
  convFile(chin, insize, fout);

  /* write C string end mark */
  snprintf(buf, sizeof(buf), "0};\n");
  fwrite(buf, strlen(buf), 1, fout);

  free(chin);
  fclose(fin);
  fclose(fout);
}


/******** todo ********/
static void _cal_ext_fb2bb(char* cmd){
  int has_bb, ret;
#ifdef _WIN32
  has_bb = system("busybox >NUL 2>NUL");
#else
  has_bb = system("busybox 2>&1 1>/dev/null");
#endif
  if (0==has_bb){
    char bbcmd[MAXLINE];
    sprintf(bbcmd, "busybox %s", cmd);
    ret = system(bbcmd);
  } else {ret = system(cmd);}
  if (0!=ret){puts("no busybox or native util found, todo fail");}
}

void todo(int argc, char** argv){
  char fname[MAXLINE], cmd[MAXLINE];
  get_exe_path(fname);
  strcat(fname, "_pb_todo");
  if (0 == argc) {
    sprintf(cmd, "cat -n %s", fname);
  } else if ( (2==argc)&&('d'==argv[0][0])&&(0==argv[0][1]) ) {
    sprintf(cmd, "sed -e \"%sd\" %s -i", argv[1], fname);
  } else {
    int i, mon, day, hr, min;
    char dosth[MAXLINE] = {0};
    char dt[MAXLINE] = {0};
    wa_calendar(NULL, &mon, &day, &hr, &min, NULL, 0);
    sprintf(dt, "%02d-%02d %02d:%02d", mon, day, hr, min);
    for (i=0; i<argc; i++){
      strcat(dosth, argv[i]);
      strcat(dosth, " ");
    }
    sprintf(cmd, "echo %s %s >>%s", dt, dosth, fname);
  }
  _cal_ext_fb2bb(cmd);
}


/******** wph ********/
static const unsigned char s_Makefile_str[]={
67,67,61,103,99,99,10,68,69,80,
65,84,72,61,47,100,47,111,112,51,
114,100,47,10,67,70,76,65,71,83,
32,61,32,45,99,32,45,45,115,116,
100,61,99,57,57,32,45,87,97,108,
108,32,45,112,101,100,97,110,116,105,
99,32,45,73,36,40,68,69,80,65,
84,72,41,105,110,99,108,117,100,101,
10,79,66,74,83,32,61,10,72,79,
83,84,32,61,32,36,40,115,104,101,
108,108,32,117,110,97,109,101,41,10,
105,102,101,113,32,40,36,40,72,79,
83,84,41,44,32,77,105,110,71,87,
41,10,9,85,84,76,73,66,32,61,
32,45,76,36,40,68,69,80,65,84,
72,41,108,105,98,32,45,108,119,97,
32,45,108,119,115,50,95,51,50,10,
101,108,115,101,10,9,85,84,76,73,
66,32,61,32,45,76,36,40,68,69,
80,65,84,72,41,108,105,98,32,45,
108,119,97,10,101,110,100,105,102,10,
10,108,105,98,58,32,36,40,79,66,
74,83,41,10,9,64,97,114,32,114,
99,117,32,108,105,98,119,97,46,97,
32,36,94,32,36,40,85,84,76,73,
66,41,10,10,111,98,106,47,37,46,
111,32,58,32,37,46,99,10,9,36,
40,67,67,41,32,36,40,67,70,76,
65,71,83,41,32,45,111,32,36,64,
32,36,60,10,0};

static const unsigned char s_main_c_str[]={
35,105,110,99,108,117,100,101,32,60,
115,116,100,105,111,46,104,62,10,35,
105,110,99,108,117,100,101,32,60,115,
116,100,108,105,98,46,104,62,10,10,
105,110,116,32,109,97,105,110,40,105,
110,116,32,97,114,103,99,44,32,99,
104,97,114,42,42,32,97,114,103,118,
41,123,10,32,32,114,101,116,117,114,
110,32,48,59,10,125,10,0};
static const unsigned char s_utest_c_str[]={
35,105,110,99,108,117,100,101,32,34,
119,97,108,105,98,46,104,34,10,10,
105,110,116,32,116,101,115,116,65,40,
41,123,10,9,10,125,10,10,105,110,
116,32,109,97,105,110,40,105,110,116,
32,97,114,103,99,44,32,99,104,97,
114,42,42,32,97,114,103,118,41,123,
10,9,84,69,83,84,40,65,41,59,
10,9,114,101,116,117,114,110,32,119,
97,95,117,116,115,117,109,40,41,59,
10,125,10,0};
static const unsigned char s_ico_rc_str[]={
65,32,73,67,79,78,32,34,120,46,
105,99,111,34,10,0};

/*create C project template file*/
static void createCPro(){
  FILE *mf=NULL;
  _cal_ext_fb2bb("mkdir src");
  _cal_ext_fb2bb("mkdir test");
  _cal_ext_fb2bb("mkdir res");
  mf = fopen("Makefile", "w");
  if (mf){
    fwrite(s_Makefile_str, strlen(s_Makefile_str), 1, mf);
    fclose(mf);
  }
  mf = fopen("src/main.c", "w");
  if (mf){
    fwrite(s_main_c_str, strlen(s_main_c_str), 1, mf);
    fclose(mf);
  }
  mf = fopen("test/utest.c", "w");
  if (mf){
    fwrite(s_utest_c_str, strlen(s_utest_c_str), 1, mf);
    fclose(mf);
  }
  mf = fopen("res/ico.rc", "w");
  if (mf) {
    fwrite(s_ico_rc_str, strlen(s_ico_rc_str), 1, mf);
    fclose(mf);
  }
}

static void helpC(const char* opt) {
  if (!opt) return;
  if (*opt=='c') {
    createCPro();
  } else {
    printf("Command `c' Unknown option: `%s'\n", opt);
  }
}

static const unsigned char s_nlsys_c_str[]={
35,105,110,99,108,117,100,101,32,34,
108,117,97,97,100,97,112,116,46,104,
34,10,10,115,116,97,116,105,99,32,
105,110,116,10,115,121,115,95,115,116,
114,101,114,114,111,114,32,40,108,117,
97,95,83,116,97,116,101,32,42,76,
41,10,123,10,32,32,99,111,110,115,
116,32,99,104,97,114,32,42,116,111,
99,111,100,101,32,61,32,108,117,97,
76,95,99,104,101,99,107,115,116,114,
105,110,103,40,76,44,32,49,41,59,
10,32,32,108,117,97,95,112,117,115,
104,108,105,116,101,114,97,108,40,76,
44,32,34,79,75,34,41,59,10,32,
32,114,101,116,117,114,110,32,49,59,
10,125,10,10,115,116,97,116,105,99,
32,108,117,97,76,95,82,101,103,32,
115,121,115,95,108,105,98,91,93,32,
61,32,123,10,32,32,123,34,115,116,
114,101,114,114,111,114,34,44,9,9,
115,121,115,95,115,116,114,101,114,114,
111,114,125,44,10,32,32,123,78,85,
76,76,44,32,78,85,76,76,125,10,
125,59,10,10,76,85,65,76,73,66,
95,65,80,73,32,105,110,116,10,108,
117,97,111,112,101,110,95,110,108,115,
121,115,32,40,108,117,97,95,83,116,
97,116,101,32,42,76,41,10,123,10,
32,32,108,117,97,76,95,114,101,103,
105,115,116,101,114,40,76,44,32,78,
85,76,76,44,32,115,121,115,95,108,
105,98,41,59,10,32,32,114,101,116,
117,114,110,32,49,59,10,125,10,0};

static void generateLuaRel(){
  FILE *mf = fopen("lua_nlsys.c", "w");
  if (mf){
    fwrite(s_nlsys_c_str, strlen(s_nlsys_c_str), 1, mf);
    fclose(mf);
  }
}

static void helpLua(const char* opt) {
  if (!opt) return;
  if (*opt=='p'){
    generateLuaRel();
  } else {
    printf("Command `l' Unknown option: `%s'\n", opt);
  }
}

void wph(int argc, char** argv) {
  if ( 2>=argc ) {
    usage();
  } else {
    switch (argv[1][0]) {
      case 'c': /* create project */
        helpC(argv[2]);
        break;
      case 'l': /* lua relate */
        helpLua(argv[2]);
        break;
      default :
        usage();
        break;
    }
  }
}


/******** xlispindent ********/
int isspaceline(char* buf){
    int i=0;
    for(; i<strlen(buf); ++i){
        char c = buf[i];
        if(' ' != c && '\t' != c && '\n' != c && '\r' != c)
            return 0;
    }
    return 1;
}

typedef struct _lisp_state{
    int lonely;  //num of lonely '('
    int offset;  //use for 'if' or 'cond' etc.
}lisp_state;

/* caculate state of line, return non-space position */
char* cacu_pathen(char* buf, lisp_state* st){
    int left = 0, right = 0, i = 0;
    char *pfirst = NULL, *tmp = NULL;
    while(' '==buf[i] || '\t'==buf[i]) ++i;
    pfirst = &buf[i];
    tmp = pfirst;
    while (*tmp != 0){
        if('('==*tmp){++left;}
        else if(')'==*tmp){++right;}
        ++tmp;
    }
    st->lonely = left-right;
    return pfirst;
}
#define ALLW "                                                                 "
void indent_file(FILE* file){
    char output[8192] = {0};
    lisp_state last_state={0}, line_state={0};
    while (1){
        char line[120] = {0};
        if (NULL == fgets(line, sizeof(line), file)){
            printf("%s", output);
            break;
        }
        //if this line is meanless, output all reserve string
        if(isspaceline(line)){
            printf("%s\n", output);
            memset(output, 0, sizeof(output));
        }
        else{
            int end = 0;
            char* pfirst = cacu_pathen(line, &line_state);
            //if line is begin with ')", append it to last line
            if(')'==*pfirst){
                char* pend = output + strlen(output);
                while('\r'==*(pend-1) || '\n'==*(pend-1))
                    *(--pend) = 0;
                goto APPEND;
            }
            strcat(output, ALLW);
            end = strlen(output) - strlen(ALLW) + 2 * last_state.lonely;
            output[end] = 0;
APPEND:
            strcat(output, pfirst);
            last_state.lonely += line_state.lonely;
        }
    }
}

void xlispindent(int argc, char** argv){
    if (argc==1) {
        /* If input is from pipe, use stdin as FILE* */
        indent_file(stdin);
    } else {
        int i=1;
        for(; i<argc; ++i){
            FILE* f = fopen(argv[i], "r");
            f? indent_file(f): printf("cant open file %s\n", argv[i]);
        }
    }
}


/******** lua ********/
#ifdef SUPPORT_LUA
char *s_lua_precode = "";
void _debug_lua(void* L, char* hint){
#ifdef SUPPORT_LUA
  int stk_size = lua_gettop(L), i = 1;
  printf("%s elem num: %d\n", hint, stk_size);
  for(;i<=stk_size;i++){
    printf("%d: %s\n", i, lua_typename(L, lua_type(L, i)));
  }
#endif
}
/*fmt|split|popen*/
static void luafn_s(lua_State* L) {
  const unsigned char B1[]={
    27,76,117,97,81,0,1,4,4,4,8,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,2,28,146,0,0,0,
    36,0,0,0,7,0,0,0,5,64,0,0,100,64,0,0,
    9,64,0,129,5,192,0,0,100,128,0,0,9,64,0,130,
    10,64,0,0,9,192,65,131,7,64,1,0,3,0,0,0,
    74,192,1,0,73,0,66,132,73,64,194,132,73,192,66,133,
    73,64,67,134,73,192,67,135,73,64,68,136,73,192,68,137,
    138,64,0,0,137,0,69,138,197,64,5,0,0,1,128,0,
    220,0,1,1,22,0,0,128,137,128,129,3,225,128,0,0,
    22,0,255,127,228,192,0,0,0,0,128,0,36,1,1,0,
    100,65,1,0,0,0,0,0,164,129,1,0,0,0,128,1,
    228,193,1,0,10,66,1,0,9,2,1,139,9,66,129,139,
    9,130,129,128,9,194,1,140,69,130,6,0,9,66,130,140,
    36,0,2,0,0,0,0,4,69,66,1,0,164,66,2,0,
    0,0,0,0,73,130,130,141,67,2,128,4,164,130,2,0,
    192,2,0,5,1,3,7,0,65,131,4,0,129,3,4,0,
    193,131,3,0,220,130,128,2,0,3,0,5,65,3,7,0,
    129,131,4,0,193,3,4,0,1,132,3,0,65,68,7,0,
    129,132,7,0,193,196,7,0,28,131,0,4,64,3,0,5,
    129,3,2,0,193,3,5,0,1,68,2,0,65,196,2,0,
    129,68,3,0,193,196,3,0,1,69,4,0,65,197,4,0,
    129,5,8,0,92,131,0,5,128,3,0,5,193,67,8,0,
    1,132,8,0,65,196,8,0,156,131,0,2,202,195,0,0,
    201,3,201,144,201,67,73,145,201,131,201,145,36,196,2,0,
    100,4,3,0,164,68,3,0,228,132,3,0,0,0,0,9,
    36,197,3,0,0,0,128,8,0,0,128,9,0,0,128,6,
    0,0,0,1,100,5,4,0,0,0,0,8,0,0,0,6,
    0,0,128,8,164,69,4,0,0,0,0,8,0,0,0,6,
    0,0,0,7,0,0,128,8,0,0,128,7,228,133,4,0,
    0,0,0,8,0,0,128,5,0,0,128,4,0,0,128,8,
    36,198,4,0,0,0,0,8,0,0,128,5,0,0,128,8,
    0,0,128,4,74,70,4,0,73,6,133,132,73,70,133,147,
    73,70,5,148,73,70,133,148,73,70,5,149,73,70,133,149,
    73,70,5,150,73,70,133,150,73,70,5,151,73,70,133,151,
    73,70,5,152,73,70,133,152,73,134,133,137,73,134,133,134,
    73,134,133,135,73,198,5,153,73,6,134,153,100,2,5,0,
    0,0,128,12,0,0,128,8,133,70,1,0,228,70,5,0,
    0,0,128,4,0,0,0,8,0,0,128,5,0,0,128,8,
    137,198,6,154,30,0,128,0,53,0,0,0,4,4,0,0,
    0,102,109,116,0,4,7,0,0,0,115,116,114,105,110,103,
    0,4,6,0,0,0,115,112,108,105,116,0,4,3,0,0,
    0,111,115,0,4,6,0,0,0,112,111,112,101,110,0,4,
    5,0,0,0,106,115,111,110,0,4,9,0,0,0,95,118,
    101,114,115,105,111,110,0,4,6,0,0,0,48,46,49,46,
    50,0,4,2,0,0,0,92,0,4,2,0,0,0,34,0,
    4,2,0,0,0,8,0,4,2,0,0,0,98,0,4,2,
    0,0,0,12,0,4,2,0,0,0,102,0,4,2,0,0,
    0,10,0,4,2,0,0,0,110,0,4,2,0,0,0,13,
    0,4,2,0,0,0,114,0,4,2,0,0,0,9,0,4,
    2,0,0,0,116,0,4,2,0,0,0,47,0,4,6,0,
    0,0,112,97,105,114,115,0,4,4,0,0,0,110,105,108,
    0,4,6,0,0,0,116,97,98,108,101,0,4,7,0,0,
    0,110,117,109,98,101,114,0,4,8,0,0,0,98,111,111,
    108,101,97,110,0,4,9,0,0,0,116,111,115,116,114,105,
    110,103,0,4,7,0,0,0,101,110,99,111,100,101,0,4,
    2,0,0,0,32,0,4,2,0,0,0,93,0,4,2,0,
    0,0,125,0,4,2,0,0,0,44,0,4,2,0,0,0,
    117,0,4,5,0,0,0,116,114,117,101,0,4,6,0,0,
    0,102,97,108,115,101,0,4,5,0,0,0,110,117,108,108,
    0,1,1,1,0,0,4,2,0,0,0,48,0,4,2,0,
    0,0,49,0,4,2,0,0,0,50,0,4,2,0,0,0,
    51,0,4,2,0,0,0,52,0,4,2,0,0,0,53,0,
    4,2,0,0,0,54,0,4,2,0,0,0,55,0,4,2,
    0,0,0,56,0,4,2,0,0,0,57,0,4,2,0,0,
    0,45,0,4,2,0,0,0,91,0,4,2,0,0,0,123,
    0,4,7,0,0,0,100,101,99,111,100,101,0,22,0,0,
    0,0,0,0,0,1,0,0,0,8,0,0,0,0,1,3,
    12,18,0,0,0,138,0,0,0,229,0,0,0,162,64,0,
    0,193,64,0,0,199,0,0,0,193,128,0,0,20,1,0,
    1,65,129,0,0,224,64,1,128,203,193,64,0,69,2,0,
    0,134,130,1,1,193,130,0,0,220,129,128,2,0,0,128,
    3,223,0,254,127,30,0,0,1,30,0,128,0,4,0,0,
    0,4,5,0,0,0,104,111,108,101,0,4,3,0,0,0,
    123,125,0,3,0,0,0,0,0,0,240,63,4,5,0,0,
    0,103,115,117,98,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,10,0,0,0,25,0,
    0,0,0,2,0,12,33,0,0,0,138,0,0,0,193,0,
    0,0,1,1,0,0,65,65,0,0,129,1,0,0,203,129,
    64,0,64,2,128,0,128,2,128,1,194,2,128,0,220,129,
    128,2,0,1,128,3,26,1,0,0,22,128,1,128,203,193,
    64,0,64,2,128,1,141,2,64,2,220,129,0,2,64,1,
    128,3,204,0,64,2,22,192,0,128,203,193,64,0,64,2,
    128,1,220,129,128,1,64,1,128,3,197,1,1,0,198,65,
    193,3,0,2,0,1,64,2,128,2,220,65,128,1,26,65,
    0,0,22,64,249,127,158,0,0,1,30,0,128,0,6,0,
    0,0,3,0,0,0,0,0,0,240,63,4,1,0,0,0,
    0,4,5,0,0,0,102,105,110,100,0,4,4,0,0,0,
    115,117,98,0,4,6,0,0,0,116,97,98,108,101,0,4,
    7,0,0,0,105,110,115,101,114,116,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,27,
    0,0,0,33,0,0,0,0,1,0,7,20,0,0,0,75,
    0,64,0,193,64,0,0,1,129,0,0,92,128,0,2,0,
    0,128,0,69,192,0,0,70,0,193,0,128,0,0,0,92,
    128,0,1,139,64,193,0,1,129,1,0,156,128,128,1,203,
    192,193,0,220,64,0,1,203,0,66,1,65,65,2,0,129,
    129,2,0,221,0,0,2,222,0,0,0,30,0,128,0,11,
    0,0,0,4,5,0,0,0,103,115,117,98,0,4,2,0,
    0,0,96,0,4,3,0,0,0,92,96,0,4,3,0,0,
    0,105,111,0,4,6,0,0,0,112,111,112,101,110,0,4,
    5,0,0,0,114,101,97,100,0,4,3,0,0,0,42,97,
    0,4,6,0,0,0,99,108,111,115,101,0,4,4,0,0,
    0,115,117,98,0,3,0,0,0,0,0,0,240,63,3,0,
    0,0,0,0,0,0,192,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,83,0,0,0,85,
    0,0,0,1,1,0,6,14,0,0,0,65,0,0,0,132,
    0,0,0,134,0,0,1,154,64,0,0,22,64,1,128,133,
    64,0,0,134,128,64,1,193,192,0,0,11,1,65,0,28,
    1,0,1,156,128,0,0,85,128,128,0,94,0,0,1,30,
    0,128,0,5,0,0,0,4,2,0,0,0,92,0,4,7,
    0,0,0,115,116,114,105,110,103,0,4,7,0,0,0,102,
    111,114,109,97,116,0,4,6,0,0,0,117,37,48,52,120,
    0,4,5,0,0,0,98,121,116,101,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,88,
    0,0,0,90,0,0,0,0,1,0,2,3,0,0,0,65,
    0,0,0,94,0,0,1,30,0,128,0,1,0,0,0,4,
    5,0,0,0,110,117,108,108,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,93,0,0,
    0,132,0,0,0,1,2,0,15,109,0,0,0,138,0,0,
    0,90,64,0,0,22,64,0,128,202,0,0,0,64,0,128,
    1,198,0,128,0,218,0,0,0,22,128,0,128,197,0,0,
    0,1,65,0,0,220,64,0,1,73,128,64,0,197,192,0,
    0,0,1,0,0,65,1,1,0,220,128,128,1,23,64,193,
    1,22,0,1,128,197,128,1,0,0,1,0,0,220,128,0,
    1,23,64,193,1,22,128,11,128,193,192,1,0,5,1,2,
    0,64,1,0,0,28,1,1,1,22,0,2,128,5,66,2,
    0,64,2,128,3,28,130,0,1,87,128,66,4,22,128,0,
    128,5,2,0,0,65,194,2,0,28,66,0,1,204,0,193,
    1,33,65,0,0,22,0,253,127,20,1,0,0,87,0,129,
    1,22,128,0,128,5,1,0,0,65,1,3,0,28,65,0,
    1,5,65,3,0,64,1,0,0,28,1,1,1,22,192,1,
    128,69,130,3,0,70,194,195,4,128,2,0,1,196,2,0,
    0,0,3,0,4,64,3,128,0,220,2,128,1,92,66,0,
    0,33,129,0,0,22,64,253,127,73,64,65,0,1,1,4,
    0,69,129,3,0,70,65,196,2,128,1,0,1,193,129,4,
    0,92,129,128,1,129,193,4,0,21,129,1,2,30,1,0,
    1,22,64,9,128,197,0,2,0,0,1,0,0,220,0,1,
    1,22,64,5,128,5,66,2,0,64,2,0,3,28,130,0,
    1,87,0,69,4,22,128,0,128,5,2,0,0,65,194,2,
    0,28,66,0,1,5,130,3,0,6,194,67,4,64,2,0,
    1,132,2,0,0,192,2,0,3,0,3,128,0,156,130,128,
    1,193,66,5,0,4,3,0,0,64,3,128,3,128,3,128,
    0,28,131,128,1,149,2,3,5,28,66,128,1,225,128,0,
    0,22,192,249,127,73,64,65,0,193,128,5,0,5,129,3,
    0,6,65,68,2,64,1,0,1,129,129,4,0,28,129,128,
    1,65,193,5,0,213,64,129,1,222,0,0,1,30,0,128,
    0,24,0,0,0,4,6,0,0,0,101,114,114,111,114,0,
    4,19,0,0,0,99,105,114,99,117,108,97,114,32,114,101,
    102,101,114,101,110,99,101,0,1,1,4,7,0,0,0,114,
    97,119,103,101,116,0,3,0,0,0,0,0,0,240,63,0,
    4,5,0,0,0,110,101,120,116,0,3,0,0,0,0,0,
    0,0,0,4,6,0,0,0,112,97,105,114,115,0,4,5,
    0,0,0,116,121,112,101,0,4,7,0,0,0,110,117,109,
    98,101,114,0,4,42,0,0,0,105,110,118,97,108,105,100,
    32,116,97,98,108,101,58,32,109,105,120,101,100,32,111,114,
    32,105,110,118,97,108,105,100,32,107,101,121,32,116,121,112,
    101,115,0,4,28,0,0,0,105,110,118,97,108,105,100,32,
    116,97,98,108,101,58,32,115,112,97,114,115,101,32,97,114,
    114,97,121,0,4,7,0,0,0,105,112,97,105,114,115,0,
    4,6,0,0,0,116,97,98,108,101,0,4,7,0,0,0,
    105,110,115,101,114,116,0,4,2,0,0,0,91,0,4,7,
    0,0,0,99,111,110,99,97,116,0,4,2,0,0,0,44,
    0,4,2,0,0,0,93,0,4,7,0,0,0,115,116,114,
    105,110,103,0,4,2,0,0,0,58,0,4,2,0,0,0,
    123,0,4,2,0,0,0,125,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,135,0,0,
    0,137,0,0,0,1,1,0,6,9,0,0,0,65,0,0,
    0,139,64,64,0,1,129,0,0,68,1,0,0,156,128,0,
    2,193,0,0,0,85,192,128,0,94,0,0,1,30,0,128,
    0,3,0,0,0,4,2,0,0,0,34,0,4,5,0,0,
    0,103,115,117,98,0,4,10,0,0,0,91,37,122,1,45,
    31,92,34,93,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,140,0,0,0,146,0,0,
    0,0,1,0,5,26,0,0,0,23,0,0,0,22,0,2,
    128,69,0,0,0,70,64,192,0,82,0,128,0,89,64,0,
    0,22,192,0,128,69,0,0,0,70,64,192,0,25,0,128,
    0,22,192,1,128,69,128,0,0,129,192,0,0,197,0,1,
    0,0,1,0,0,220,128,0,1,1,65,1,0,149,0,1,
    1,92,64,0,1,69,128,1,0,70,192,193,0,129,0,2,
    0,192,0,0,0,93,0,128,1,94,0,0,0,30,0,128,
    0,9,0,0,0,4,5,0,0,0,109,97,116,104,0,4,
    5,0,0,0,104,117,103,101,0,4,6,0,0,0,101,114,
    114,111,114,0,4,26,0,0,0,117,110,101,120,112,101,99,
    116,101,100,32,110,117,109,98,101,114,32,118,97,108,117,101,
    32,39,0,4,9,0,0,0,116,111,115,116,114,105,110,103,
    0,4,2,0,0,0,39,0,4,7,0,0,0,115,116,114,
    105,110,103,0,4,7,0,0,0,102,111,114,109,97,116,0,
    4,6,0,0,0,37,46,49,52,103,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,158,
    0,0,0,165,0,0,0,1,2,0,8,19,0,0,0,133,
    0,0,0,192,0,0,0,156,128,0,1,196,0,0,0,198,
    128,128,1,218,0,0,0,22,0,1,128,0,1,128,1,64,
    1,0,0,128,1,128,0,29,1,128,1,30,1,0,0,5,
    65,0,0,65,129,0,0,128,1,0,1,193,193,0,0,85,
    193,129,2,28,65,0,1,30,0,128,0,4,0,0,0,4,
    5,0,0,0,116,121,112,101,0,4,6,0,0,0,101,114,
    114,111,114,0,4,18,0,0,0,117,110,101,120,112,101,99,
    116,101,100,32,116,121,112,101,32,39,0,4,2,0,0,0,
    39,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,168,0,0,0,170,0,0,0,1,1,
    0,3,5,0,0,0,68,0,0,0,128,0,0,0,92,128,
    0,1,94,0,0,1,30,0,128,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,179,0,0,0,185,0,0,0,0,0,3,9,16,0,
    0,0,74,0,0,0,129,0,0,0,197,64,0,0,1,129,
    0,0,101,1,0,0,220,128,0,0,1,1,0,0,160,0,
    1,128,133,65,0,0,192,1,128,2,37,2,0,0,156,129,
    0,0,73,192,64,3,159,64,254,127,94,0,0,1,30,0,
    128,0,4,0,0,0,3,0,0,0,0,0,0,240,63,4,
    7,0,0,0,115,101,108,101,99,116,0,4,2,0,0,0,
    35,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,199,0,0,0,206,0,0,0,
    0,4,0,12,17,0,0,0,0,1,128,0,84,1,0,0,
    129,1,0,0,32,193,1,128,11,66,64,0,128,2,128,3,
    192,2,128,3,28,130,0,2,6,2,2,1,87,192,0,4,
    22,0,0,128,222,1,0,1,31,129,253,127,20,1,0,0,
    12,1,64,2,30,1,0,1,30,0,128,0,2,0,0,0,
    3,0,0,0,0,0,0,240,63,4,4,0,0,0,115,117,
    98,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,209,0,0,0,220,0,0,0,0,3,
    0,13,26,0,0,0,193,0,0,0,1,1,0,0,65,1,
    0,0,141,1,192,0,193,1,0,0,96,1,2,128,12,1,
    64,2,75,66,64,0,192,2,0,4,0,3,0,4,92,130,
    0,2,23,128,192,4,22,64,0,128,204,0,192,1,1,1,
    0,0,95,65,253,127,69,193,0,0,133,1,1,0,134,65,
    65,3,193,129,1,0,0,2,0,1,64,2,128,1,128,2,
    0,2,156,1,128,2,92,65,0,0,30,0,128,0,7,0,
    0,0,3,0,0,0,0,0,0,240,63,4,4,0,0,0,
    115,117,98,0,4,2,0,0,0,10,0,4,6,0,0,0,
    101,114,114,111,114,0,4,7,0,0,0,115,116,114,105,110,
    103,0,4,7,0,0,0,102,111,114,109,97,116,0,4,21,
    0,0,0,37,115,32,97,116,32,108,105,110,101,32,37,100,
    32,99,111,108,32,37,100,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,223,0,0,0,
    237,0,0,0,0,1,0,7,71,0,0,0,69,0,0,0,
    70,64,192,0,25,128,64,0,22,64,1,128,133,192,0,0,
    134,0,65,1,192,0,0,0,157,0,0,1,158,0,0,0,
    22,0,13,128,25,64,65,0,22,128,2,128,133,192,0,0,
    134,0,65,1,192,0,128,0,15,129,65,0,220,128,0,1,
    204,192,193,1,16,129,65,0,12,1,66,2,157,0,128,1,
    158,0,0,0,22,192,9,128,25,64,66,0,22,192,3,128,
    133,192,0,0,134,0,65,1,192,0,128,0,15,129,66,0,
    220,128,0,1,204,192,194,1,0,1,128,0,80,129,66,0,
    79,129,193,2,28,129,0,1,12,1,66,2,80,129,65,0,
    76,1,194,2,157,0,0,2,158,0,0,0,22,64,5,128,
    25,0,67,0,22,192,4,128,133,192,0,0,134,0,65,1,
    192,0,128,0,15,65,67,0,220,128,0,1,204,128,195,1,
    0,1,128,0,80,65,67,0,79,129,194,2,28,129,0,1,
    12,1,66,2,64,1,128,0,144,129,66,0,143,129,65,3,
    92,129,0,1,76,1,194,2,144,129,65,0,140,1,66,3,
    157,0,128,2,158,0,0,0,133,192,3,0,197,192,0,0,
    198,0,196,1,1,65,4,0,64,1,0,0,220,0,128,1,
    156,64,0,0,30,0,128,0,18,0,0,0,4,5,0,0,
    0,109,97,116,104,0,4,6,0,0,0,102,108,111,111,114,
    0,3,0,0,0,0,0,192,95,64,4,7,0,0,0,115,
    116,114,105,110,103,0,4,5,0,0,0,99,104,97,114,0,
    3,0,0,0,0,0,252,159,64,3,0,0,0,0,0,0,
    80,64,3,0,0,0,0,0,0,104,64,3,0,0,0,0,
    0,0,96,64,3,0,0,0,0,224,255,239,64,3,0,0,
    0,0,0,0,176,64,3,0,0,0,0,0,0,108,64,3,
    0,0,0,0,255,255,48,65,3,0,0,0,0,0,0,16,
    65,3,0,0,0,0,0,0,110,64,4,6,0,0,0,101,
    114,114,111,114,0,4,7,0,0,0,102,111,114,109,97,116,
    0,4,31,0,0,0,105,110,118,97,108,105,100,32,117,110,
    105,99,111,100,101,32,99,111,100,101,112,111,105,110,116,32,
    39,37,120,39,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,240,0,0,0,249,0,0,
    0,1,1,0,7,30,0,0,0,69,0,0,0,139,64,64,
    0,1,129,0,0,65,193,0,0,156,128,0,2,193,0,1,
    0,92,128,128,1,133,0,0,0,203,64,64,0,65,65,1,
    0,129,129,1,0,220,128,0,2,1,1,1,0,156,128,128,
    1,154,0,0,0,22,0,2,128,196,0,0,0,13,193,193,
    0,14,1,66,2,77,65,66,1,12,65,1,2,12,129,66,
    2,221,0,0,1,222,0,0,0,22,192,0,128,196,0,0,
    0,0,1,128,0,221,0,0,1,222,0,0,0,30,0,128,
    0,11,0,0,0,4,9,0,0,0,116,111,110,117,109,98,
    101,114,0,4,4,0,0,0,115,117,98,0,3,0,0,0,
    0,0,0,240,63,3,0,0,0,0,0,0,16,64,3,0,
    0,0,0,0,0,48,64,3,0,0,0,0,0,0,28,64,
    3,0,0,0,0,0,0,36,64,3,0,0,0,0,0,0,
    235,64,3,0,0,0,0,0,0,144,64,3,0,0,0,0,
    0,128,235,64,3,0,0,0,0,0,0,240,64,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,252,0,0,0,34,1,0,0,4,2,0,13,94,0,0,
    0,129,0,0,0,204,64,192,0,0,1,128,1,84,1,0,
    0,25,64,129,1,22,64,20,128,75,129,64,0,192,1,128,
    1,92,129,128,1,24,192,192,2,22,64,1,128,132,1,0,
    0,192,1,0,0,0,2,128,1,65,2,1,0,156,65,0,
    2,22,0,17,128,23,64,193,2,22,192,13,128,128,1,0,
    1,203,129,65,0,64,2,0,2,141,66,192,1,220,129,0,
    2,149,192,1,3,204,64,192,1,139,129,65,0,0,2,128,
    1,64,2,128,1,156,129,0,2,23,192,65,3,22,0,6,
    128,203,1,66,0,65,66,2,0,140,66,192,1,220,129,0,
    2,218,65,0,0,22,128,2,128,203,1,66,0,65,130,2,
    0,140,66,192,1,220,129,0,2,218,65,0,0,22,0,1,
    128,196,1,0,0,0,2,0,0,77,66,192,1,129,194,2,
    0,220,129,0,2,0,2,0,1,68,2,128,0,128,2,128,
    3,92,130,0,1,149,64,2,4,20,2,128,3,204,0,130,
    1,22,192,3,128,196,1,0,1,198,129,129,3,218,65,0,
    0,22,192,1,128,196,1,0,0,0,2,0,0,77,66,192,
    1,129,2,3,0,192,2,0,3,1,67,3,0,149,2,3,
    5,220,65,0,2,192,1,0,1,4,2,128,1,6,130,1,
    4,149,0,130,3,12,65,192,1,22,128,2,128,23,128,195,
    2,22,0,2,128,128,1,0,1,203,129,65,0,64,2,0,
    2,141,66,192,1,220,129,0,2,149,192,1,3,128,1,0,
    1,204,65,192,1,158,1,128,1,204,64,192,1,22,128,234,
    127,68,1,0,0,128,1,0,0,192,1,128,0,1,194,3,
    0,92,65,0,2,30,0,128,0,16,0,0,0,4,1,0,
    0,0,0,3,0,0,0,0,0,0,240,63,4,5,0,0,
    0,98,121,116,101,0,3,0,0,0,0,0,0,64,64,4,
    28,0,0,0,99,111,110,116,114,111,108,32,99,104,97,114,
    97,99,116,101,114,32,105,110,32,115,116,114,105,110,103,0,
    3,0,0,0,0,0,0,87,64,4,4,0,0,0,115,117,
    98,0,4,2,0,0,0,117,0,4,6,0,0,0,109,97,
    116,99,104,0,4,28,0,0,0,94,91,100,68,93,91,56,
    57,97,65,98,66,93,37,120,37,120,92,117,37,120,37,120,
    37,120,37,120,0,4,10,0,0,0,94,37,120,37,120,37,
    120,37,120,0,4,33,0,0,0,105,110,118,97,108,105,100,
    32,117,110,105,99,111,100,101,32,101,115,99,97,112,101,32,
    105,110,32,115,116,114,105,110,103,0,4,22,0,0,0,105,
    110,118,97,108,105,100,32,101,115,99,97,112,101,32,99,104,
    97,114,32,39,0,4,12,0,0,0,39,32,105,110,32,115,
    116,114,105,110,103,0,3,0,0,0,0,0,0,65,64,4,
    34,0,0,0,101,120,112,101,99,116,101,100,32,99,108,111,
    115,105,110,103,32,113,117,111,116,101,32,102,111,114,32,115,
    116,114,105,110,103,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,37,1,0,0,45,1,
    0,0,3,2,0,11,26,0,0,0,132,0,0,0,192,0,
    0,0,0,1,128,0,68,1,128,0,156,128,0,2,203,0,
    64,0,64,1,128,0,141,65,64,1,220,128,0,2,5,129,
    0,0,64,1,128,1,28,129,0,1,26,65,0,0,22,192,
    1,128,68,1,0,1,128,1,0,0,192,1,128,0,1,194,
    0,0,64,2,128,1,129,2,1,0,21,130,2,4,92,65,
    0,2,64,1,0,2,128,1,0,1,94,1,128,1,30,0,
    128,0,5,0,0,0,4,4,0,0,0,115,117,98,0,3,
    0,0,0,0,0,0,240,63,4,9,0,0,0,116,111,110,
    117,109,98,101,114,0,4,17,0,0,0,105,110,118,97,108,
    105,100,32,110,117,109,98,101,114,32,39,0,4,2,0,0,
    0,39,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,48,1,0,0,55,1,0,0,5,
    2,0,10,26,0,0,0,132,0,0,0,192,0,0,0,0,
    1,128,0,68,1,128,0,156,128,0,2,203,0,64,0,64,
    1,128,0,141,65,64,1,220,128,0,2,4,1,0,1,6,
    193,0,2,26,65,0,0,22,192,1,128,4,1,128,1,64,
    1,0,0,128,1,128,0,193,129,0,0,0,2,128,1,65,
    194,0,0,213,65,130,3,28,65,0,2,4,1,0,2,6,
    193,0,2,64,1,0,1,30,1,128,1,30,0,128,0,4,
    0,0,0,4,4,0,0,0,115,117,98,0,3,0,0,0,
    0,0,0,240,63,4,18,0,0,0,105,110,118,97,108,105,
    100,32,108,105,116,101,114,97,108,32,39,0,4,2,0,0,
    0,39,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,58,1,0,0,82,1,0,0,4,
    2,0,10,54,0,0,0,138,0,0,0,193,0,0,0,76,
    0,192,0,3,1,0,2,68,1,0,0,128,1,0,0,192,
    1,128,0,4,2,128,0,66,2,128,0,92,129,128,2,64,
    0,128,2,75,65,64,0,192,1,128,0,0,2,128,0,92,
    129,0,2,23,128,192,2,22,64,0,128,76,0,192,0,22,
    128,7,128,68,1,0,1,128,1,0,0,192,1,128,0,92,
    193,128,1,64,0,0,3,0,1,128,2,137,0,129,1,204,
    0,192,1,68,1,0,0,128,1,0,0,192,1,128,0,4,
    2,128,0,66,2,128,0,92,129,128,2,64,0,128,2,75,
    65,64,0,192,1,128,0,0,2,128,0,92,129,0,2,76,
    0,192,0,23,128,192,2,22,0,0,128,22,192,1,128,87,
    192,192,2,22,128,245,127,132,1,128,1,192,1,0,0,0,
    2,128,0,65,2,1,0,156,65,0,2,22,0,244,127,0,
    1,0,1,64,1,128,0,30,1,128,1,30,0,128,0,5,
    0,0,0,3,0,0,0,0,0,0,240,63,4,4,0,0,
    0,115,117,98,0,4,2,0,0,0,93,0,4,2,0,0,
    0,44,0,4,20,0,0,0,101,120,112,101,99,116,101,100,
    32,39,93,39,32,111,114,32,39,44,39,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    85,1,0,0,119,1,0,0,4,2,0,10,94,0,0,0,
    138,0,0,0,76,0,192,0,195,0,0,2,68,1,0,0,
    128,1,0,0,192,1,128,0,4,2,128,0,66,2,128,0,
    92,129,128,2,64,0,128,2,75,65,64,0,192,1,128,0,
    0,2,128,0,92,129,0,2,23,128,192,2,22,64,0,128,
    76,0,192,0,22,192,17,128,75,65,64,0,192,1,128,0,
    0,2,128,0,92,129,0,2,87,192,192,2,22,0,1,128,
    68,1,0,1,128,1,0,0,192,1,128,0,1,2,1,0,
    92,65,0,2,68,1,128,1,128,1,0,0,192,1,128,0,
    92,193,128,1,64,0,0,3,192,0,128,2,68,1,0,0,
    128,1,0,0,192,1,128,0,4,2,128,0,66,2,128,0,
    92,129,128,2,64,0,128,2,75,65,64,0,192,1,128,0,
    0,2,128,0,92,129,0,2,87,64,193,2,22,0,1,128,
    68,1,0,1,128,1,0,0,192,1,128,0,1,130,1,0,
    92,65,0,2,68,1,0,0,128,1,0,0,204,1,192,0,
    4,2,128,0,66,2,128,0,92,129,128,2,64,0,128,2,
    68,1,128,1,128,1,0,0,192,1,128,0,92,193,128,1,
    64,0,0,3,0,1,128,2,137,0,129,1,68,1,0,0,
    128,1,0,0,192,1,128,0,4,2,128,0,66,2,128,0,
    92,129,128,2,64,0,128,2,75,65,64,0,192,1,128,0,
    0,2,128,0,92,129,0,2,76,0,192,0,23,128,192,2,
    22,0,0,128,22,192,1,128,87,192,193,2,22,64,235,127,
    132,1,0,1,192,1,0,0,0,2,128,0,65,2,2,0,
    156,65,0,2,22,192,233,127,192,0,0,1,0,1,128,0,
    222,0,128,1,30,0,128,0,9,0,0,0,3,0,0,0,
    0,0,0,240,63,4,4,0,0,0,115,117,98,0,4,2,
    0,0,0,125,0,4,2,0,0,0,34,0,4,24,0,0,
    0,101,120,112,101,99,116,101,100,32,115,116,114,105,110,103,
    32,102,111,114,32,107,101,121,0,4,2,0,0,0,58,0,
    4,23,0,0,0,101,120,112,101,99,116,101,100,32,39,58,
    39,32,97,102,116,101,114,32,107,101,121,0,4,2,0,0,
    0,44,0,4,20,0,0,0,101,120,112,101,99,116,101,100,
    32,39,125,39,32,111,114,32,39,44,39,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    143,1,0,0,150,1,0,0,2,2,0,10,22,0,0,0,
    139,0,64,0,0,1,128,0,64,1,128,0,156,128,0,2,
    196,0,0,0,198,128,128,1,218,0,0,0,22,0,1,128,
    0,1,128,1,64,1,0,0,128,1,128,0,29,1,128,1,
    30,1,0,0,4,1,128,0,64,1,0,0,128,1,128,0,
    193,65,0,0,0,2,0,1,65,130,0,0,213,65,130,3,
    28,65,0,2,30,0,128,0,3,0,0,0,4,4,0,0,
    0,115,117,98,0,4,23,0,0,0,117,110,101,120,112,101,
    99,116,101,100,32,99,104,97,114,97,99,116,101,114,32,39,
    0,4,2,0,0,0,39,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,153,1,0,0,
    163,1,0,0,4,1,0,8,38,0,0,0,69,0,0,0,
    128,0,0,0,92,128,0,1,87,64,192,0,22,128,1,128,
    69,128,0,0,129,192,0,0,197,0,0,0,0,1,0,0,
    220,128,0,1,149,192,0,1,92,64,0,1,68,0,0,0,
    128,0,0,0,196,0,128,0,0,1,0,0,65,1,1,0,
    132,1,0,1,194,1,128,0,220,0,128,2,92,192,0,0,
    196,0,128,0,0,1,0,0,64,1,0,1,132,1,0,1,
    194,1,128,0,220,128,128,2,128,0,128,1,212,0,0,0,
    25,192,0,1,22,0,1,128,196,0,128,1,0,1,0,0,
    64,1,0,1,129,65,1,0,220,64,0,2,94,0,0,1,
    30,0,128,0,6,0,0,0,4,5,0,0,0,116,121,112,
    101,0,4,7,0,0,0,115,116,114,105,110,103,0,4,6,
    0,0,0,101,114,114,111,114,0,4,39,0,0,0,101,120,
    112,101,99,116,101,100,32,97,114,103,117,109,101,110,116,32,
    111,102,32,116,121,112,101,32,115,116,114,105,110,103,44,32,
    103,111,116,32,0,3,0,0,0,0,0,0,240,63,4,17,
    0,0,0,116,114,97,105,108,105,110,103,32,103,97,114,98,
    97,103,101,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  };
  if (luaL_loadbuffer(L,(const char*)B1,sizeof(B1),"init_chunk")==0)
    lua_call(L, 0, 0);
}
#endif

void* linit(){
  void *L = NULL;
#ifdef SUPPORT_LUA
  L = (lua_State *)luaL_newstate();  /* create state */
  if (L == NULL) {
    puts("cannot create lua_State: not enough memory");
  } else {
    lua_gc(L, LUA_GCSTOP, 0);  /* stop collector during initialization */
    luaL_openlibs(L);  /* open libraries */
    luaopen_utf8(L);
    luaopen_enc(L);
    luaopen_dt (L);
    lua_gc(L, LUA_GCRESTART, 0);
    lua_pop(L, 3);  // pop custom open_lib
    luafn_s(L);
    /* luaL_dostring(L, s_lua_precode); */
  }
#endif
  return L;
}

int ldofile(void* L, char *fname, int narg){
  int status = 0;
#ifdef SUPPORT_LUA
  status = luaL_loadfile(L, fname);
  if (0!=status) {
    printf("load %s fail[%d]: %s %s\n", fname, status, lua_tostring(L, -2), lua_tostring(L, -1));
    lua_pop(L, 2);
    return status;
  }
  if (0<narg) {lua_insert(L, 1);}
  status = lua_pcall(L, narg, LUA_MULTRET, 0);
  if (0!=status) {
    printf("run %s fail[%d]: %s %s\n",fname, status, lua_tostring(L, -2), lua_tostring(L, -1));
    lua_pop(L, 2);
  } else {
    lua_pop(L, 1);
  }
#endif
  return status; /*0-ok 1-fail*/
}

void lclose(void* L){
#ifdef SUPPORT_LUA
  lua_close((lua_State *)L);
#endif
}

#include "modidx_lua.c"
void run_lua(int argc, char** argv){
#ifdef SUPPORT_LUA
  void *L = linit();
  if (2==argc) {
    char fname[MAXLINE];
    get_exe_path(fname);
    strcat(fname, "init.lua");
    ldofile(L, fname, 0);
  } else if (0==strcmp(argv[2], "-e")) {
    char exprbuff[MAXLINE] = {0};
    if (3==argc){usage();}
    sprintf(exprbuff, "return %s", argv[3]);
    luaL_dostring(L, exprbuff);
    puts(lua_tostring(L, -1));
  } else if (0==strcmp(argv[2], "-h")) {
    puts("single: fmt/string.split/os.popen/dt.datediff\n"
    "module: enc.md5/sha1/b64enc/b64dec; json.encode/decode; utf8.len/char/codes");
  } else {
    int narr = argc - 3, i;
    lua_createtable(L, narr, 0);
    for (i=3; i < argc; i++) {
      lua_pushstring(L, argv[i]);
      lua_rawseti(L, -2, i-2);
    }
    lua_setglobal(L, "arg");
    if (0==strcmp(argv[2], "-y")) {
      luafn_modidx(L);
    } else {
      ldofile(L, argv[2], 0);
    }
  }
  lclose(L);
#else
  miniscm(argc-1, argv+1);
#endif
}


void enc_lua(int argc, char *argv[])
{
  char buf[MAXLINE] = {0}, flname[128]={0};
  char *pos, *fl_pos;
  int i = 0, ret;
  char fndecl[256] = {0};
  FILE *fw, *fr;

  if (argc <2){
    usage();
  }

  sprintf(buf, "luac -s %s", argv[1]); /*drop debug*/
  ret = system(buf);
  if (0!=ret){puts("luac fail");return;}

  sprintf(buf, "%s.c", argv[1]);
  pos = strchr(buf, '.');
  *pos = '_';
  fr = fopen("luac.out", "rb");
  fw = fopen(buf, "w");
  printf("encode lua bytecode to %s\n", buf);
  fl_pos = strrchr(buf, '/')?strrchr(buf, '/'):strrchr(buf, '\\');
  if (NULL==fl_pos){strcpy(flname, buf);}
  else {strcpy(flname, fl_pos+1);}
  fl_pos = strchr(flname, '_');
  *fl_pos = 0;

  *pos = 0; // let buf be the lua module name
  sprintf(fndecl, "#include \"lua/lauxlib.h\"\n\n"
    "static void luafn_%s(lua_State* L) {\n"
    "  const unsigned char B1[]={", flname);
  fwrite(fndecl, strlen(fndecl), 1, fw);

  while(1){
#define comma    ","
#define nline    "\n    "
    unsigned char ch;
    char fch[4] = {0};
    int cnt = fread(&ch, 1, 1, fr);
    if (cnt == 0) {break;}
    else if ( (i++)%16 == 0) {fwrite(nline, 5, 1, fw);}
    sprintf(fch, "%u", ch); // convert to string
    fwrite(&fch, strlen(fch), 1, fw);
    fwrite(comma, 1, 1, fw);
    //if (feof(fr)) break;
  }
  /*lua_call keep result and set global, or 1->0 then not set*/
  sprintf(fndecl, "\n  };\n\n  if (luaL_loadbuffer"
    "(L,(const char*)B1,sizeof(B1),\"buf_chunk_%s\")==0)\n"
    "    lua_call(L, 0, 1);\n"
    "  lua_setglobal(L, \"%s\");\n"
    "}\n", flname, flname);
  fwrite(fndecl, strlen(fndecl), 1, fw);
  fclose(fr);
  fclose(fw);
}


int main(int argc, char** argv){
  if (1==argc){
    usage();
  } else {
    switch(argv[1][0]){
      case 'a':
        ascii();
        break;
      case 'c':
        snip(argc-2, argv+2, 1, 0);
        break;
      case 'd':
        dyn2str(argc-1, argv+1);
        break;
      case 'e':
        enc_lua(argc-1, argv+1);
        break;
      case 'h':
        help_show_csv(argc-1, argv+1);
        break;
      case 'l':
        run_lua(argc, argv);
        break;
      case 's':
        snip(argc-2, argv+2, 0, 0);
        break;
      case 't':
        todo(argc-2, argv+2);
        break;
      case 'w':
        wph(argc-1, argv+1);
        break;
      case 'x':
        xlispindent(argc-1, argv+1);
        break;
    default:
        break;
    }
  }
  return 0;
}
